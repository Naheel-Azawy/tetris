<html>
    <head>
        <meta charset="utf-8" />
        <title>Tetris</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">


        <style>
         body, button, select, input, a {
             color:       white;
             font-family: monospace;
         }

         body, button, select, input {
             background-color: #000000;
         }

         button {
             width: 100%;
             width:  50px;
             height: 50px;
         }

         #board td, #board-next td {
             /*border: 1px solid white;*/
             width:  25px;
             height: 25px;
         }

         #board, #board-next {
             border-collapse: collapse;
             border-bottom:   2px solid white;
             border-left:     2px solid white;
             border-right:    2px solid white;
         }

         #board-next {
             border-top: 2px solid white;
         }

         #game-over {
             width: 100%;
             text-align: center;
         }
        </style>
    </head>
    <body>

        <div id="content" style="max-width: 500px; margin: auto">
            <button onclick="data[msg] = PAUSE" style="float: right">||</button>
            <br><br>

            <table style="margin: auto"><tr>
                <td><table id="board"></table></td>
                <td>
                    Next: <br>
                    <table id="board-next"></table>
                    <br>
                    <table>
                        <tr><td>Shapes:</td> <td id="shapes"></td></tr>
                        <tr><td>Rows:  </td> <td id="rows">  </td></tr>
                        <tr><td>Score: </td> <td id="score"> </td></tr>
                        <tr><td><a href="https://github.com/Naheel-Azawy/tetris">Source</a></td></tr>
                    </table>
                </td>
            </tr></table>

            <br>
            <table style="width: 80%; margin: auto">
                <tr>
                    <td><button onclick="data[msg] = LEFT">&lt</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = BOTTOM">B</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = RIGHT">&gt</button></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button onclick="data[msg] = DOWN">D</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = ROTATE1">R</button></td>
                    <td></td>
                </tr>
            </table>
        </div>

        <h2 id="game-over"></h2>

        <script>
/*
 * Copyright (C) 2021-present naheel-azawy
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

const tetris_asm = atob(`
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
`);

// tetris_asm is auto generated
const tetris_codearray = new Uint8Array(tetris_asm.length);
for (let i in tetris_asm) tetris_codearray[i] = tetris_asm.charCodeAt(i);

// check tetris.h
const NONE    = 0;
const QUIT    = 1;
const REDRAW  = 2;
const PAUSE   = 3;
const BOTTOM  = 4;
const DOWN    = 5;
const RIGHT   = 6;
const LEFT    = 7;
const ROTATE1 = 8;
const ROTATE2 = 9;

const W       = 10;
const H       = 20;
const T       = 4;
const DELAY   = 10;

let w;
let h;
let data;
let data_len;
let score, rows, shapes, gameover, drawf, msg, now;

async function delay(time) {
    return new Promise((resolve) => setTimeout(resolve, time));
}

async function run_game() {
    const wasm = await WebAssembly.instantiate(tetris_codearray);
    let { memory, setup, loop, get_data_len } = wasm.instance.exports;

    w = W;
    h = H;
    data_len = get_data_len(w, h);
    data = new Int32Array(memory.buffer, 0, data_len);

    score    = data_len - 7;
    shapes   = data_len - 6;
    rows     = data_len - 5;
    gameover = data_len - 4;
    drawf    = data_len - 3;
    msg      = data_len - 2;
    now      = data_len - 1;

    let _setup = setup;
    let _loop = loop;
    setup = () => { data[now] = Date.now(); _setup(w, h, data); };
    loop  = () => { data[now] = Date.now(); _loop(); };

    data[msg] = NONE;
    setup();

    for (;;) {
        loop();
        if (data[msg] != NONE) {
            data[msg] = NONE;
        }

        if (data[drawf]) { // draw flag

            for (let j = 0; j < h; ++j) {
                for (let i = 0; i < w; ++i) {
                    set_cell(i, j, data[w * j + i]);
                }
            }

            // TODO: why j=0 is messed up?
            for (let j = 1; j < T; ++j) {
                for (let i = 0; i < T; ++i) {
                    set_cell(i, j, data[(w * h) + T * j + i], true);
                }
            }

            document.getElementById("score").innerText  = data[score];
            document.getElementById("rows").innerText   = data[rows];
            document.getElementById("shapes").innerText = data[shapes];

            if (data[gameover]) {
                let c = document.getElementById("content");
                let o = document.getElementById("game-over");
                c.style.visibility = "collapse";
                o.innerHTML = "<br>GAME OVER!<br><br>" +
                    "Shapes: " + data[shapes] + "<br>" +
                    "Rows: "   + data[rows]   + "<br>" +
                    "Score: "  + data[score]  + "<br>";
                await delay(3000);
                o.innerHTML = "";
                c.style.visibility = "visible";
                break;
            } else {
                await delay(DELAY);
            }

            data[drawf] = 0;
        } else {
            await delay(DELAY);
        }
    }
}

function set_cell(i, j, val, next) {
    next = next ? "-next" : "";
    document.getElementById(`cell${next}-${i},${j}`).style.background =
        val == 0 ? "black" : "white";
}

async function main() {
    window.onbeforeunload = () => "Are you sure you want to leave?";

    document.addEventListener("keydown", event => {
        switch (event.key) {
        case "ArrowRight": data[msg] = RIGHT;   break;
        case "ArrowLeft":  data[msg] = LEFT;    break;
        case "ArrowUp":    data[msg] = ROTATE1; break;
        case "ArrowDown":  data[msg] = DOWN;    break;
        case " ":          data[msg] = BOTTOM;  break;
        case "p":          data[msg] = PAUSE;   break;
        }
    });

    let table, tr, td;

    table = document.getElementById("board");
    for (let j = 0; j < H; ++j) {
        tr = document.createElement("tr");
        table.appendChild(tr);
        for (let i = 0; i < W; ++i) {
            td = document.createElement("td");
            td.id = `cell-${i},${j}`;
            tr.appendChild(td);
        }
    }

    table = document.getElementById("board-next");
    for (let j = 0; j < T; ++j) {
        tr = document.createElement("tr");
        table.appendChild(tr);
        for (let i = 0; i < T; ++i) {
            td = document.createElement("td");
            td.id = `cell-next-${i},${j}`;
            tr.appendChild(td);
        }
    }

    for (;;) await run_game();
}

main();
        </script>
    </body>
</html>

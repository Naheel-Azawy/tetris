<html>
    <head>
        <meta charset="utf-8" />
        <title>Tetris</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">


        <style>
         body, button, select, input, a {
             color:       white;
             font-family: monospace;
         }

         body, button, select, input {
             background-color: #000000;
         }

         button {
             width: 100%;
             width:  50px;
             height: 50px;
         }

         #board td, #board-next td {
             /*border: 1px solid white;*/
             width:  25px;
             height: 25px;
         }

         #board, #board-next {
             border-collapse: collapse;
             border-bottom:   2px solid white;
             border-left:     2px solid white;
             border-right:    2px solid white;
         }

         #board-next {
             border-top: 2px solid white;
         }

         #game-over {
             width: 100%;
             text-align: center;
         }
        </style>
    </head>
    <body>

        <div id="content" style="max-width: 500px; margin: auto">
            <button onclick="data[msg] = PAUSE" style="float: right">||</button>
            <br><br>

            <table style="margin: auto"><tr>
                <td><table id="board"></table></td>
                <td>
                    Next: <br>
                    <table id="board-next"></table>
                    <br>
                    <table>
                        <tr><td>Shapes:</td> <td id="shapes"></td></tr>
                        <tr><td>Rows:  </td> <td id="rows">  </td></tr>
                        <tr><td>Score: </td> <td id="score"> </td></tr>
                        <tr><td><a href="https://github.com/Naheel-Azawy/tetris">Source</a></td></tr>
                    </table>
                </td>
            </tr></table>

            <br>
            <table style="width: 80%; margin: auto">
                <tr>
                    <td><button onclick="data[msg] = LEFT">&lt</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = BOTTOM">B</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = RIGHT">&gt</button></td>
                </tr>
                <tr>
                    <td></td>
                    <td><button onclick="data[msg] = DOWN">D</button></td>
                    <td></td>
                    <td><button onclick="data[msg] = ROTATE1">R</button></td>
                    <td></td>
                </tr>
            </table>
        </div>

        <h2 id="game-over"></h2>

        <script>
const tetris_asm = atob(`
AGFzbQEAAAABKwhgAABgA39/fwBgAAF/YAF/AX9gA39/fwF/YAF/AGACf38Bf2ADf35/AX4DFhUB
AQEEAAAAAgMAAAYBAAICAgUDAwMEBQFwAQEBBQYBAYACgAIGCQF/AUHwi8ACCweIAQoGbWVtb3J5
AgAMZ2V0X2RhdGFfbGVuAAsFc2V0dXAADARsb29wAA0ZX19pbmRpcmVjdF9mdW5jdGlvbl90YWJs
ZQEAEF9fZXJybm9fbG9jYXRpb24ADwZmZmx1c2gAEwlzdGFja1NhdmUAEAxzdGFja1Jlc3RvcmUA
EQpzdGFja0FsbG9jABIK1BcVYQECfwNAAkAgAiADaiIEQQBIDQAgBEHYCSgCAEEEak4NACAAIARB
AXRqIgQgBC8BACADQQF0QY4Lai8BACABdHJB//8DQdQJKAIAdEF/c3E7AQALIANBAWoiA0EERw0A
CwufAwEFfyABQQJqIAEgAkEGRhtBBG8iA0EBTgRAIABBAmohBQNAQcAJQgA3AwBBACECA0AgBSAC
QQF0ai8BACEEQQAhAQNAIAFBAXRBwAlqIgcgBy8BACAEQQMgAWt2QQFxIAJ0cjsBACABQQFqIgFB
BEcNAAsgAkEBaiICQQRHDQALQQAhAgJAQcAJLwEADQADQEEAIQEDQCABQQF0QcAJaiABQQFqIgFB
AXRBwAlqLwEAOwEAIAFBA0cNAAtBxglBADsBACACQQJLDQEgAkEBaiECQcAJLwEARQ0ACwtBACEC
A0BBACEBAkADQCABQQF0QcAJai0AAEEBcQ0BIAFBAWoiAUEERw0AC0EAIQEDQCABQQF0QcAJaiIE
IAQvAQBBAXQ7AQAgAUEBaiIBQQRHDQALIAJBAWoiAkEERw0BCwsgBUHACSkDADcBACAGQQFqIgYg
A0cNAAsLIAAvAQAhASAAIAFBBHRB8AFxIAFBBHZBD3EgAUGAfnFyciABIANBAXEbIgFB/+EDcSAD
IAFBCHZBD3FqQQRvQQh0cjsBAAswAQJ/IAJBAEoEQANAIAEgA0EBdCIEaiAAIARqLwEAOwEAIANB
AWoiAyACRw0ACwsLWgEFfyACQQFIBEBBAA8LIAFBAUghBgNAIAZFBEAgACADQQF0ai8BACEHQQAh
BQNAIAcgBXZBAXEgBGohBCAFQQFqIgUgAUcNAAsLIANBAWoiAyACRw0ACyAECyEAEA5BB29BCmxB
gAhqQZYLQQUQAkGWCxAOQQRvQQcQAQs8AQF/QZYLQYwLQQUQAhAEQbALQQRBjAsvAQAiAEEPcWs2
AgBBrAtB1AkoAgBBAm0gAEEFdkEHcWs2AgALowMBAn9BqAtBADYCAEGgC0IANwIAQbQLQQA2AgAQ
ByEAQcwLQQA6AABBxAtBATsBAEG4CyAANgIAQdgJKAIAQQRqIgBBAU4EQAJAIABBAXQiAEUNACAA
QdwJaiIBQQFrQQA6AABB3AlBADoAACAAQQNJDQAgAUECa0EAOgAAQd0JQQA6AAAgAUEDa0EAOgAA
Qd4JQQA6AAAgAEEHSQ0AIAFBBGtBADoAAEHfCUEAOgAAIABBCUkNAEHcCUEANgIAIABBfHEiAUHc
CWoiAEEEa0EANgIAIAFBCUkNAEHkCUEANgIAQeAJQQA2AgAgAEEIa0EANgIAIABBDGtBADYCACAB
QRlJDQBB9AlBADYCAEHwCUEANgIAQewJQQA2AgBB6AlBADYCACAAQRBrQQA2AgAgAEEUa0EANgIA
IABBGGtBADYCACAAQRxrQQA2AgAgAUEcayIBQSBJDQBB+AkhAANAIABCADcDGCAAQgA3AxAgAEIA
NwMIIABCADcDACAAQSBqIQAgAUEgayIBQR9LDQALCwtB0AsQB0EBa603AwAQBBAFCxgAQcgJKAIA
QcwJKAIAQQJ0akEEaygCAAuBAwEFf0GwCygCACEDQawLKAIAIQECQAJAAkACQAJAAkACQCAAQQRr
DgYDAAECBAQGCyADQQFqIQMMBAsgAUEBaiEBDAMLIAFBAWshAQwCC0HMC0EBOgAAQQEPC0GMC0EB
QQZBByAAQQhGGxABQdQJKAIAIgJBjAsvAQBBBHZBD3EiBGsgASABIARqIAJKGyEBC0EAIQIgAUEA
SA0AQdQJKAIAQYwLLwEAIgRBBHZBD3EgAWpIDQBBAiECQdgJKAIAQQRqIgUgBEEPcSADakgNAEHc
CUG0CiAFEAJBtApB1AkoAgBB2AkoAgBBBGoQAyECQY4LQQRBBBADIQRBtAogASADEABBtApB1Ako
AgBB2AkoAgBBBGoQAyACIARqRwRAQQchAQJAAkACQCAAQQhrDgIBAAILQQYhAQtBjAtBASABEAEL
QdwJQbQKQdgJKAIAQQRqEAJBtApBrAsoAgBBsAsoAgAQAEECDwtBsAsgAzYCAEGsCyABNgIAQQEh
AgsgAguGAwEFf0HYCSgCACIAQQBKBEBB1AkoAgAhAkEEIQEDQCACQQBKBEAgAUEEayEDIAFBAXRB
0AlqIQRBACEAA0AQCkHICSgCAEHUCSgCACADbCAAakECdGogBC8BZCAAdkEBcTYCACAAQQFqIgBB
1AkoAgAiAkgNAAtB2AkoAgAhAAsgASAAQQNqSCEDIAFBAWohASADDQALC0EAIQEDQCABQQJ0IQMg
AUEBdEHQCWohBEEAIQADQBAKQcgJKAIAIgIgACADakHYCSgCAEHUCSgCAGxqQQJ0aiAELwHGASAA
dkEBcTYCACAAQQFqIgBBBEcNAAsgAUEBaiIBQQRHDQALQdgJKAIAQdQJKAIAbEECdCACakFAa0Go
CygCADYCAEHYCSgCAEHUCSgCAGxBAnQgAmpBoAsoAgA2AkRB2AkoAgBB1AkoAgBsQQJ0IAJqQaQL
KAIANgJIQdgJKAIAQdQJKAIAbEECdCACakEANgJMQdgJKAIAQdQJKAIAbEECdCACakEBNgJQCx4A
QcgLQcgJKAIAQcwJKAIAQQJ0akEIaygCADYCAAsKACAAIAFsQRdqCygAQcgJIAI2AgBBzAkgACAB
EAs2AgBB2AkgATYCAEHUCSAANgIAEAYLqgUCBX8BfBAKAkACQAJAAkACQAJAAkBByAsoAgAiAA4K
BQADAQICAgICAgQLQcQLQQA6AAAMAwtBxQstAAAEQBAHIQBBxQtBADoAAEG4CyAANgIADAMLQcUL
QQE6AAAMAgsgABAIGgsQCQtByAtBADYCAAwBCwJAAkBBzAstAAAEQEEFEAhBAUcNAQwCC0HFCy0A
AA0CQbwLAn9EAAAAAAAANEBBpAsoAgC3RAAAAAAAAElAoKNEAAAAAABAj0CiIgWZRAAAAAAAAOBB
YwRAIAWqDAELQYCAgIB4CyIANgIAEAdBuAsoAgAgAGoiAEkNAkG4CyAANgIAQeIJLwEABEBByAko
AgAiAEHYCSgCAEHUCSgCAGxBAnRqQUBrQagLKAIANgIAIABB2AkoAgBB1AkoAgBsQQJ0akGgCygC
ADYCRCAAQdgJKAIAQdQJKAIAbEECdGpBpAsoAgA2AkggAEHYCSgCAEHUCSgCAGxBAnRqQQE2Akwg
AEHYCSgCAEHUCSgCAGxBAnRqQQE2AlAQBgwDC0HAC0EFEAgiADYCAAJAAkAgAA4DBAEAAQtBoAtB
oAsoAgBBAWo2AgBBqAtBqAsoAgBBjAsvAQAiAEEIdkHwAXEgAEEGdkE8cWpB0AhqKAIAajYCAEHc
CUGsCygCAEGwCygCABAAEAULQdgJKAIAIgBBAUgNASAAQQNqIQFB//8DQdQJKAIAdEF/c0H//wNx
IQIDQCABQQF0QdAJaiIALwEMIAJHBH8gAQUgAEEAOwEMIAEhAANAIABBAXRB3AlqIABBAWsiA0EB
dEHcCWovAQA7AQAgAEEESiEEIAMhACAEDQALQaQLQaQLKAIAQQFqNgIAIAFBAWoLIgBBAWshASAA
QQRKDQALDAELQcwLQQA6AAAMAQsQCQsLJwEBfkHQC0HQCykDAEKt/tXk1IX9qNgAfkIBfCIANwMA
IABCIYinCwUAQdgLCwQAIwALBgAgACQACxAAIwAgAGtBcHEiACQAIAALZwEBfyAABEAgACgCTEF/
TARAIAAQFA8LIAAQFA8LQegLKAIABEBB6AsoAgAQEyEBC0HkCygCACIABEADQCAAKAJMGiAAKAIU
IAAoAhxLBEAgABAUIAFyIQELIAAoAjgiAA0ACwsgAQtpAQJ/AkAgACgCFCAAKAIcTQ0AIABBAEEA
IAAoAiQRBAAaIAAoAhQNAEF/DwsgACgCBCIBIAAoAggiAkkEQCAAIAEgAmusQQEgACgCKBEHABoL
IABBADYCHCAAQgA3AxAgAEIANwIEQQALC7kBAgBBgAgLPyIAAwADAAAAAAAyEAcABAAAAAAAMiAH
AAEAAAAAADIwAwAGAAAAAAAyQAYAAwAAAAAAMlACAAcAAAAAAEFgDwBB0AgLbQYAAAAGAAAABgAA
AAYAAAAGAAAABwAAAAYAAAAHAAAABgAAAAcAAAAGAAAABwAAAAYAAAAHAAAABgAAAAcAAAAGAAAA
BwAAAAYAAAAHAAAABQAAAAUAAAAGAAAABQAAAAUAAAAIAAAABQAAAAg=
`);

// tetris_asm is auto generated
const tetris_codearray = new Uint8Array(tetris_asm.length);
for (let i in tetris_asm) tetris_codearray[i] = tetris_asm.charCodeAt(i);

// check tetris.h
const NONE    = 0;
const QUIT    = 1;
const REDRAW  = 2;
const PAUSE   = 3;
const BOTTOM  = 4;
const DOWN    = 5;
const RIGHT   = 6;
const LEFT    = 7;
const ROTATE1 = 8;
const ROTATE2 = 9;

const W       = 10;
const H       = 20;
const T       = 4;
const DELAY   = 10;

let w;
let h;
let data;
let data_len;
let score, rows, shapes, gameover, drawf, msg, now;

async function delay(time) {
    return new Promise((resolve) => setTimeout(resolve, time));
}

async function run_game() {
    const wasm = await WebAssembly.instantiate(tetris_codearray);
    let { memory, setup, loop, get_data_len } = wasm.instance.exports;

    w = W;
    h = H;
    data_len = get_data_len(w, h);
    data = new Int32Array(memory.buffer, 0, data_len);

    score    = data_len - 7;
    shapes   = data_len - 6;
    rows     = data_len - 5;
    gameover = data_len - 4;
    drawf    = data_len - 3;
    msg      = data_len - 2;
    now      = data_len - 1;

    let _setup = setup;
    let _loop = loop;
    setup = () => { data[now] = Date.now(); _setup(w, h, data); };
    loop  = () => { data[now] = Date.now(); _loop(); };

    data[msg] = NONE;
    setup();

    for (;;) {
        loop();
        if (data[msg] != NONE) {
            data[msg] = NONE;
        }

        if (data[drawf]) { // draw flag

            for (let j = 0; j < h; ++j) {
                for (let i = 0; i < w; ++i) {
                    set_cell(i, j, data[w * j + i]);
                }
            }

            // TODO: why j=0 is messed up?
            for (let j = 1; j < T; ++j) {
                for (let i = 0; i < T; ++i) {
                    set_cell(i, j, data[(w * h) + T * j + i], true);
                }
            }

            document.getElementById("score").innerText  = data[score];
            document.getElementById("rows").innerText   = data[rows];
            document.getElementById("shapes").innerText = data[shapes];

            if (data[gameover]) {
                let c = document.getElementById("content");
                let o = document.getElementById("game-over");
                c.style.visibility = "collapse";
                o.innerHTML = "<br>GAME OVER!<br><br>" +
                    "Shapes: " + data[shapes] + "<br>" +
                    "Rows: "   + data[rows]   + "<br>" +
                    "Score: "  + data[score]  + "<br>";
                await delay(3000);
                o.innerHTML = "";
                c.style.visibility = "visible";
                break;
            } else {
                await delay(DELAY);
            }

            data[drawf] = 0;
        } else {
            await delay(DELAY);
        }
    }
}

function set_cell(i, j, val, next) {
    next = next ? "-next" : "";
    document.getElementById(`cell${next}-${i},${j}`).style.background =
        val == 0 ? "black" : "white";
}

async function main() {
    window.onbeforeunload = () => "Are you sure you want to leave?";

    document.addEventListener("keydown", event => {
        switch (event.key) {
        case "ArrowRight": data[msg] = RIGHT;   break;
        case "ArrowLeft":  data[msg] = LEFT;    break;
        case "ArrowUp":    data[msg] = ROTATE1; break;
        case "ArrowDown":  data[msg] = DOWN;    break;
        case " ":          data[msg] = BOTTOM;  break;
        case "p":          data[msg] = PAUSE;   break;
        }
    });

    let table, tr, td;

    table = document.getElementById("board");
    for (let j = 0; j < H; ++j) {
        tr = document.createElement("tr");
        table.appendChild(tr);
        for (let i = 0; i < W; ++i) {
            td = document.createElement("td");
            td.id = `cell-${i},${j}`;
            tr.appendChild(td);
        }
    }

    table = document.getElementById("board-next");
    for (let j = 0; j < T; ++j) {
        tr = document.createElement("tr");
        table.appendChild(tr);
        for (let i = 0; i < T; ++i) {
            td = document.createElement("td");
            td.id = `cell-next-${i},${j}`;
            tr.appendChild(td);
        }
    }

    for (;;) await run_game();
}

main();
        </script>
    </body>
</html>
